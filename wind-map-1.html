<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wind Map</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Courier+Prime:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0f0a;
    --text: #c8d8c0;
    --muted: #4a6040;
    --calm: #1e4020;
    --light: #3a7030;
    --moderate: #6aaa60;
    --fresh: #a8d898;
    --strong: #e0f0a0;
    --gale: #f0dc50;
    --storm: #f08020;
    --city: #a0e8a0;
    --city-bright: #d0ffd0;
    --border-char: #2a4a28;
    --graticule: #182818;
    --label: #3a5a38;
    --accent: #60d060;
    --panel-bg: #050a05;
    --border: #1a2a1a;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Courier Prime', 'Courier New', monospace;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  #topbar {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    padding: 0 16px;
    height: 34px;
    background: var(--panel-bg);
    border-bottom: 1px solid var(--border);
    font-size: 0.7rem;
    letter-spacing: 0.05em;
    user-select: none;
    gap: 8px;
    overflow: hidden;
    white-space: nowrap;
  }

  #topbar-title {
    color: var(--accent);
    font-weight: 700;
    letter-spacing: 0.18em;
    font-size: 0.75rem;
    flex-shrink: 0;
  }

  .tb-dot {
    width: 6px; height: 6px; border-radius: 50%;
    background: var(--muted); flex-shrink: 0;
    transition: background 0.3s;
  }
  .tb-dot.loading { background: var(--gale); animation: blink 0.8s infinite; }
  .tb-dot.ok      { background: var(--accent); }
  .tb-dot.error   { background: var(--storm); }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.2} }

  #topbar-status { color: var(--muted); font-style: italic; flex: 1; overflow: hidden; text-overflow: ellipsis; }
  #tb-coords { color: var(--label); flex-shrink: 0; font-size: 0.65rem; }

  #ctrlbar {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 4px 16px;
    background: var(--panel-bg);
    border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
  }

  .ctrl-label {
    font-size: 0.58rem;
    letter-spacing: 0.12em;
    color: var(--muted);
    text-transform: uppercase;
    flex-shrink: 0;
  }

  button {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--muted);
    font-family: 'Courier Prime', monospace;
    font-size: 0.65rem;
    padding: 2px 9px;
    cursor: pointer;
    letter-spacing: 0.05em;
    transition: color 0.12s, border-color 0.12s;
    white-space: nowrap;
    flex-shrink: 0;
  }
  button:hover  { color: var(--accent); border-color: var(--accent); }
  button.active { color: var(--accent); border-color: var(--accent); }

  .ctrl-divider { width: 1px; height: 16px; background: var(--border); margin: 0 2px; flex-shrink: 0; }

  input[type=text] {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'Courier Prime', monospace;
    font-size: 0.65rem;
    padding: 2px 7px;
    width: 70px;
    outline: none;
    letter-spacing: 0.04em;
  }
  input[type=text]:focus { border-color: var(--accent); }
  input[type=text]::placeholder { color: var(--muted); }

  #map-wrap {
    flex: 1;
    overflow: hidden;
    position: relative;
  }

  #map {
    position: absolute;
    top: 0; left: 0;
    font-family: 'Courier Prime', 'Courier New', monospace;
    font-size: 13px;
    line-height: 1.35;
    letter-spacing: 0.08em;
    white-space: pre;
    padding: 4px 8px;
    user-select: text;
    cursor: text;
  }

  #legend {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    gap: 0;
    padding: 3px 16px;
    background: var(--panel-bg);
    border-top: 1px solid var(--border);
    font-size: 0.58rem;
    letter-spacing: 0.05em;
    color: var(--muted);
    overflow: hidden;
    white-space: nowrap;
    user-select: none;
  }
  .li { margin-right: 14px; }

  /* character classes */
  .s0 { color: var(--calm); }
  .s1 { color: var(--light); }
  .s2 { color: var(--moderate); }
  .s3 { color: var(--fresh); }
  .s4 { color: var(--strong); }
  .s5 { color: var(--gale); }
  .s6 { color: var(--storm); }
  .cn { color: var(--city); font-weight: 700; }       /* city name */
  .ca { color: var(--city-bright); }                  /* city arrow */
  .bo { color: var(--border-char); }                  /* border line */
  .gr { color: var(--graticule); }                    /* graticule */
  .lb { color: var(--label); }                        /* lat/lon labels */

  #tooltip {
    position: fixed;
    pointer-events: none;
    background: var(--panel-bg);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'Courier Prime', monospace;
    font-size: 0.63rem;
    padding: 6px 10px;
    line-height: 1.9;
    letter-spacing: 0.04em;
    opacity: 0;
    transition: opacity 0.12s;
    z-index: 99;
    white-space: nowrap;
  }
  #tooltip.show { opacity: 1; }
  .tt-v { color: var(--accent); }
</style>
</head>
<body>

<div id="topbar">
  <span id="topbar-title">WIND MAP</span>
  <div class="tb-dot" id="tb-dot"></div>
  <span id="topbar-status">initialising…</span>
  <span style="color:var(--border)">|</span>
  <span id="tb-coords">—</span>
</div>

<div id="ctrlbar">
  <span class="ctrl-label">Region</span>
  <button class="region-btn active" data-region="namerica">N. America</button>
  <button class="region-btn" data-region="europe">Europe</button>
  <button class="region-btn" data-region="asia">Asia–Pac</button>
  <button class="region-btn" data-region="world">World</button>

  <div class="ctrl-divider"></div>
  <span class="ctrl-label">Custom</span>
  <input type="text" id="in-n" placeholder="N lat">
  <input type="text" id="in-s" placeholder="S lat">
  <input type="text" id="in-w" placeholder="W lon">
  <input type="text" id="in-e" placeholder="E lon">
  <button id="btn-go">Go</button>

  <div class="ctrl-divider"></div>
  <span class="ctrl-label">Units</span>
  <button class="unit-btn active" data-unit="kmh">km/h</button>
  <button class="unit-btn" data-unit="mph">mph</button>
  <button class="unit-btn" data-unit="ms">m/s</button>

  <div class="ctrl-divider"></div>
  <span class="ctrl-label">Show</span>
  <button id="btn-borders" class="active" title="Toggle borders">Borders</button>
  <button id="btn-cities"  class="active" title="Toggle cities">Cities</button>
  <button id="btn-grid"    title="Toggle graticule">Grid</button>

  <div class="ctrl-divider"></div>
  <button id="btn-refresh">↺ Refresh</button>
  <button id="btn-copy">⎘ Copy</button>
</div>

<div id="map-wrap">
  <pre id="map"></pre>
</div>

<div id="legend">
  <span class="li"><span class="s0">→</span> calm</span>
  <span class="li"><span class="s1">→</span> light</span>
  <span class="li"><span class="s2">→</span> moderate</span>
  <span class="li"><span class="s3">→</span> fresh</span>
  <span class="li"><span class="s4">→</span> strong</span>
  <span class="li"><span class="s5">→</span> gale</span>
  <span class="li"><span class="s6">→</span> storm</span>
  <span class="li" style="color:var(--city)">· city</span>
  <span class="li" style="color:var(--border-char)">· border</span>
  <span style="margin-left:auto;color:var(--muted)">open-meteo · natural earth · select to copy</span>
</div>

<div id="tooltip"></div>

<script>
'use strict';

// ═══════════════════════════════════════════════════════════════════
// COUNTRY BORDERS  (Natural Earth 110m, simplified to 1° precision)
// Each entry: [lon, lat] pairs forming a polyline (not closed polygon—
// we rasterize edges, so open polylines work fine)
// ═══════════════════════════════════════════════════════════════════

const BORDERS = [
  // ── North America ─────────────────────────────────────────────
  // US outline (lower 48)
  [[-124,49],[-110,49],[-100,49],[-90,49],[-84,46],[-83,42],[-80,43],[-79,44],[-75,45],[-72,45],[-70,47],[-67,45],[-67,44],[-70,43],[-71,42],[-74,40],[-76,38],[-76,37],[-77,35],[-77,34],[-80,32],[-81,30],[-85,30],[-87,30],[-89,29],[-91,29],[-93,29],[-97,26],[-100,28],[-104,29],[-108,31],[-111,31],[-117,32],[-118,34],[-122,37],[-124,40],[-124,49]],
  // US-Canada border (49th parallel detail)
  [[-67,45],[-70,47],[-72,45],[-75,45],[-76,44],[-78,44],[-79,44],[-80,43],[-83,42],[-84,46],[-90,49],[-100,49],[-110,49],[-120,49],[-124,49]],
  // Canada outline
  [[-141,60],[-135,60],[-120,60],[-110,60],[-100,60],[-90,60],[-85,60],[-80,60],[-75,62],[-70,63],[-64,47],[-67,45],[-70,47],[-72,45],[-75,45],[-84,46],[-90,49],[-100,49],[-110,49],[-120,49],[-141,60]],
  // Canada north coast rough
  [[-141,60],[-141,70],[-130,70],[-120,74],[-110,74],[-100,74],[-85,68],[-80,63],[-75,62],[-70,63],[-64,47]],
  // Mexico
  [[-117,32],[-114,32],[-112,29],[-109,27],[-106,24],[-104,22],[-101,20],[-98,19],[-96,19],[-94,18],[-92,18],[-90,18],[-90,16],[-88,16],[-86,16],[-84,10],[-83,8],[-77,8],[-76,8],[-77,8],[-83,8],[-84,10],[-86,16],[-88,16],[-90,16],[-90,18],[-92,18],[-94,18],[-96,19],[-98,19],[-101,20],[-104,22],[-106,24],[-109,27],[-112,29],[-114,32],[-117,32]],
  // Alaska
  [[-141,60],[-141,70],[-156,70],[-166,68],[-168,66],[-166,64],[-162,60],[-158,57],[-152,57],[-148,60],[-141,60]],

  // ── Central America ───────────────────────────────────────────
  [[-90,18],[-88,16],[-87,16],[-85,14],[-84,10],[-83,8],[-79,8],[-77,8],[-76,8],[-76,10],[-78,10],[-80,10],[-82,10],[-84,10],[-86,14],[-87,16],[-90,18]],

  // ── South America ─────────────────────────────────────────────
  [[-80,8],[-76,8],[-72,12],[-68,10],[-62,8],[-52,8],[-52,4],[-50,2],[-50,0],[-52,-2],[-56,-4],[-60,-2],[-64,0],[-68,0],[-70,2],[-74,4],[-78,4],[-80,0],[-80,-4],[-82,-8],[-80,-14],[-78,-16],[-74,-14],[-70,-14],[-66,-20],[-68,-22],[-70,-18],[-68,-14],[-64,-14],[-60,-14],[-58,-16],[-60,-20],[-56,-24],[-52,-24],[-50,-28],[-52,-34],[-54,-38],[-58,-40],[-62,-46],[-66,-54],[-68,-56],[-72,-52],[-70,-46],[-68,-42],[-66,-38],[-66,-34],[-60,-28],[-56,-22],[-52,-20],[-48,-16],[-44,-10],[-40,-4],[-38,0],[-34,-4],[-38,-10],[-40,-4],[-44,-2],[-48,-4],[-52,-4],[-56,-4],[-60,-2],[-64,0],[-68,0],[-70,2],[-74,4],[-78,4],[-80,8]],
  // Colombia-Venezuela-Guianas north coast
  [[-78,8],[-76,8],[-72,12],[-68,10],[-62,10],[-58,8],[-52,6],[-52,4]],

  // ── Europe ────────────────────────────────────────────────────
  // Iberian Peninsula
  [[-9,44],[-8,44],[-4,44],[0,43],[3,43],[3,40],[0,38],[-1,37],[-5,36],[-7,37],[-9,39],[-9,44]],
  // France + Benelux
  [[-5,44],[-2,44],[-1,46],[0,48],[2,51],[5,51],[8,51],[8,47],[7,44],[6,43],[3,43],[0,43],[-2,43],[-4,44],[-5,44]],
  // UK
  [[-6,50],[-5,50],[-3,51],[-2,52],[-1,54],[0,55],[0,58],[-2,58],[-3,59],[-5,58],[-6,57],[-6,55],[-5,54],[-4,54],[-3,53],[-3,51],[-5,50],[-6,50]],
  // Ireland
  [[-10,52],[-8,51],[-6,52],[-6,54],[-8,55],[-10,54],[-10,52]],
  // Germany + Austria + Switzerland
  [[6,51],[8,48],[10,48],[13,48],[15,51],[14,54],[10,54],[7,55],[6,52],[6,51]],
  // Italy
  [[7,44],[7,43],[10,42],[13,38],[16,38],[15,41],[14,42],[12,44],[14,46],[13,46],[10,47],[8,46],[7,44]],
  // Scandinavia
  [[5,58],[5,62],[5,65],[8,68],[15,70],[20,70],[28,72],[30,70],[28,68],[25,64],[30,60],[28,58],[24,60],[22,61],[20,60],[18,60],[15,58],[13,56],[11,56],[8,58],[5,58]],
  // Finland + Baltics
  [[22,60],[24,58],[26,56],[24,56],[22,56],[24,58],[26,58],[28,60],[26,62],[24,64],[26,66],[28,70],[30,70],[28,68],[25,64],[30,60],[28,58],[22,60]],
  // Poland + Czechia + Slovakia
  [[14,54],[18,54],[22,56],[24,56],[22,50],[18,50],[16,50],[14,50],[13,50],[13,52],[14,54]],
  // Balkans broad
  [[13,46],[16,46],[18,46],[22,44],[24,42],[26,42],[28,42],[26,46],[24,48],[20,48],[18,46],[15,44],[13,46]],
  // Romania + Bulgaria + Moldova
  [[22,48],[24,50],[26,52],[32,52],[34,52],[36,50],[32,46],[28,46],[26,48],[22,48]],
  // Ukraine
  [[22,52],[26,52],[30,52],[34,52],[36,50],[34,46],[32,46],[28,46],[26,48],[24,48],[22,48],[22,52]],
  // Turkey
  [[26,42],[30,42],[36,42],[42,38],[42,36],[36,36],[32,36],[28,37],[26,40],[26,42]],
  // Greece
  [[22,42],[24,42],[26,42],[26,40],[24,38],[22,38],[20,40],[20,42],[22,42]],

  // ── Russia ────────────────────────────────────────────────────
  // European Russia west
  [[22,68],[28,70],[34,70],[38,64],[34,60],[32,65],[28,68],[22,68]],
  // Russia broad Siberia
  [[30,70],[40,70],[50,70],[60,72],[70,72],[80,74],[90,76],[100,76],[110,74],[120,70],[130,68],[140,64],[140,60],[136,56],[134,50],[132,48],[130,44],[134,44],[136,46],[140,44],[140,40],[136,38],[132,36],[128,34],[124,36],[120,40],[116,42],[110,44],[100,52],[90,54],[80,56],[70,58],[60,58],[50,54],[44,50],[40,48],[36,50],[34,52],[30,52],[26,52],[22,52],[22,56],[24,60],[22,60],[18,60],[20,60],[24,60],[26,66],[28,70],[30,70]],

  // ── Africa ────────────────────────────────────────────────────
  // North Africa (Mediterranean coast)
  [[-6,36],[0,37],[5,37],[10,37],[12,33],[10,30],[12,24],[16,20],[20,16],[24,20],[28,22],[32,22],[36,22],[36,14],[42,12],[44,12]],
  // Horn of Africa
  [[42,12],[44,12],[48,10],[50,10],[44,4],[40,0],[36,-2],[34,-4],[36,-8]],
  // East Africa coast
  [[36,-8],[38,-12],[40,-16],[36,-18],[34,-20],[36,-22],[36,-26],[34,-28],[32,-28],[30,-26],[28,-26],[26,-20],[26,-16],[28,-10],[30,-4],[34,-2],[36,0],[38,0],[40,2],[42,2],[44,4],[40,0]],
  // West Africa
  [[-16,16],[-12,20],[-6,20],[0,16],[4,10],[6,6],[2,6],[0,5],[-4,4],[-8,4],[-10,2],[-8,-2],[2,-4],[6,-4],[10,-2],[12,-4],[14,-2],[16,-2],[18,-2],[20,4],[22,4],[24,2],[26,-4],[28,-8],[30,-4],[34,-2],[30,-4],[26,-4],[24,2],[22,4],[20,4],[18,-2],[14,-2],[10,-2],[6,-4],[2,-4],[-4,4],[-8,4],[-12,4],[-16,4],[-16,10],[-16,16]],
  // Southern Africa
  [[14,-4],[16,-6],[18,-8],[22,-18],[24,-22],[26,-22],[28,-22],[30,-26],[32,-28],[30,-30],[28,-34],[24,-34],[20,-34],[18,-34],[16,-30],[14,-26],[12,-22],[12,-18],[12,-10],[14,-6],[14,-4]],

  // ── Middle East ───────────────────────────────────────────────
  [[36,36],[40,36],[44,38],[50,38],[56,38],[60,36],[60,26],[58,22],[54,22],[50,24],[46,24],[44,22],[42,14],[44,12],[36,14],[36,22],[36,28],[32,30],[34,30],[36,32],[34,32],[34,36],[36,36]],
  // Arabian Peninsula
  [[36,28],[40,28],[44,22],[50,20],[54,22],[56,24],[58,22],[60,22],[56,16],[52,14],[48,12],[44,12],[42,14],[44,22],[46,24],[44,22],[40,20],[38,20],[36,20],[36,28]],

  // ── South Asia ────────────────────────────────────────────────
  // India subcontinent
  [[66,36],[70,34],[72,32],[74,32],[76,32],[78,30],[80,28],[84,28],[88,26],[92,24],[94,22],[92,18],[88,14],[84,14],[80,10],[78,8],[76,8],[72,10],[68,22],[66,24],[64,22],[62,24],[60,28],[62,32],[64,36],[66,36]],
  // Sri Lanka
  [[80,10],[80,8],[82,8],[82,10],[80,10]],

  // ── SE Asia ───────────────────────────────────────────────────
  [[100,22],[104,22],[106,22],[108,20],[108,18],[106,16],[104,12],[104,10],[102,4],[100,2],[100,6],[102,6],[104,4],[106,4],[108,10],[110,12],[116,4],[118,4],[120,4],[122,10],[124,10],[126,6],[128,2],[130,-2],[128,-4],[124,-6],[118,-8],[116,-10],[112,-8],[108,-6],[104,-8],[102,-6],[100,-2],[102,2],[100,4],[100,8],[100,10],[100,14],[100,18],[100,22]],
  // Philippines broad
  [[118,18],[120,18],[122,18],[124,16],[124,12],[122,10],[120,10],[118,10],[116,10],[118,14],[118,18]],

  // ── East Asia ─────────────────────────────────────────────────
  // China
  [[76,40],[80,42],[84,42],[90,48],[94,48],[100,52],[106,50],[110,44],[116,42],[120,40],[122,38],[122,32],[120,28],[118,24],[116,22],[110,20],[108,22],[104,22],[100,22],[98,24],[96,28],[94,28],[90,28],[88,26],[84,28],[80,28],[78,30],[76,32],[74,32],[72,36],[76,40]],
  // Korean peninsula
  [[124,38],[126,38],[128,36],[128,34],[126,34],[124,36],[124,38]],
  // Japan main islands
  [[130,32],[132,34],[134,36],[136,38],[138,40],[140,42],[142,44],[144,44],[144,42],[142,38],[140,36],[138,34],[136,34],[134,32],[132,32],[130,32]],
  [[140,42],[142,44],[144,46],[144,44],[142,44]],

  // ── Australia + NZ ────────────────────────────────────────────
  [[114,-22],[118,-20],[122,-18],[128,-14],[132,-12],[136,-12],[138,-14],[140,-16],[142,-10],[144,-14],[146,-18],[148,-20],[152,-24],[154,-28],[152,-32],[150,-38],[148,-38],[144,-38],[140,-36],[136,-34],[132,-32],[128,-32],[124,-34],[116,-34],[114,-30],[112,-24],[114,-22]],
  // New Zealand North Island
  [[174,-36],[176,-36],[178,-38],[176,-40],[174,-40],[172,-40],[172,-38],[174,-36]],
  // New Zealand South Island
  [[172,-42],[174,-42],[176,-44],[174,-46],[170,-46],[168,-46],[166,-46],[168,-44],[170,-44],[172,-42]],

  // ── Greenland ─────────────────────────────────────────────────
  [[-44,60],[-50,60],[-58,62],[-64,66],[-68,70],[-68,76],[-60,76],[-50,82],[-30,84],[-20,78],[-18,74],[-24,68],[-26,64],[-34,60],[-44,60]],

  // ── Iceland ───────────────────────────────────────────────────
  [[-24,64],[-22,64],[-14,64],[-14,66],[-18,66],[-22,66],[-24,66],[-24,64]],

  // ── Caribbean broad ───────────────────────────────────────────
  [[-76,20],[-74,20],[-72,20],[-70,18],[-68,18],[-66,18],[-64,18],[-68,16],[-64,18]],
];

// ═══════════════════════════════════════════════════════════════════
// CITIES DATABASE  (name, lat, lon, population-rank for density filtering)
// Rank 1=megacity, 5=regional city — lower rank = higher priority to show
// ═══════════════════════════════════════════════════════════════════

const CITY_DB = [
  // N America
  ['New York',   40.71, -74.01, 1],
  ['Los Angeles',34.05,-118.24, 1],
  ['Chicago',    41.88, -87.63, 1],
  ['Houston',    29.76, -95.37, 1],
  ['Phoenix',    33.45,-112.07, 2],
  ['Miami',      25.77, -80.19, 2],
  ['Dallas',     32.78, -96.80, 2],
  ['Seattle',    47.61,-122.33, 2],
  ['Denver',     39.74,-104.98, 2],
  ['Atlanta',    33.75, -84.39, 2],
  ['Boston',     42.36, -71.06, 2],
  ['San Fran',   37.77,-122.42, 2],
  ['Las Vegas',  36.17,-115.14, 2],
  ['Portland',   45.52,-122.68, 3],
  ['Minneapolis',44.98, -93.27, 3],
  ['St. Louis',  38.63, -90.20, 3],
  ['Detroit',    42.33, -83.05, 3],
  ['New Orleans',29.95, -90.07, 3],
  ['Toronto',    43.65, -79.38, 1],
  ['Montreal',   45.50, -73.57, 2],
  ['Vancouver',  49.25,-123.12, 2],
  ['Calgary',    51.04,-114.07, 3],
  ['Ottawa',     45.42, -75.69, 3],
  ['Winnipeg',   49.90, -97.14, 3],
  ['Mexico City',19.43, -99.13, 1],
  ['Guadalajara',20.66,-103.35, 2],
  ['Monterrey',  25.67, -100.31, 2],
  ['Havana',     23.13, -82.38, 2],
  ['Guatemala',  14.64, -90.51, 3],
  ['Anchorage',  61.22,-149.90, 3],

  // S America
  ['São Paulo',  -23.55, -46.63, 1],
  ['Buenos Aires',-34.61,-58.38, 1],
  ['Rio',        -22.91, -43.17, 1],
  ['Lima',       -12.05, -77.04, 1],
  ['Bogota',       4.71, -74.07, 1],
  ['Santiago',   -33.46, -70.65, 1],
  ['Caracas',     10.48, -66.88, 2],
  ['Quito',        0.22, -78.51, 2],
  ['Manaus',      -3.10, -60.02, 3],
  ['Montevideo', -34.90, -56.19, 3],
  ['La Paz',     -16.50, -68.15, 3],
  ['Brasilia',   -15.78, -47.93, 2],
  ['Fortaleza',   -3.72, -38.54, 3],
  ['Recife',      -8.05, -34.88, 3],

  // Europe
  ['London',     51.51,  -0.13, 1],
  ['Paris',      48.86,   2.35, 1],
  ['Berlin',     52.52,  13.40, 1],
  ['Madrid',     40.42,  -3.70, 1],
  ['Rome',       41.90,  12.50, 1],
  ['Moscow',     55.75,  37.62, 1],
  ['Istanbul',   41.01,  28.95, 1],
  ['Amsterdam',  52.37,   4.90, 2],
  ['Brussels',   50.85,   4.35, 2],
  ['Vienna',     48.21,  16.37, 2],
  ['Warsaw',     52.23,  21.01, 2],
  ['Kyiv',       50.45,  30.52, 2],
  ['Budapest',   47.50,  19.04, 2],
  ['Prague',     50.08,  14.44, 2],
  ['Lisbon',     38.72,  -9.14, 2],
  ['Barcelona',  41.39,   2.17, 2],
  ['Munich',     48.14,  11.58, 2],
  ['Hamburg',    53.55,   9.99, 2],
  ['Stockholm',  59.33,  18.07, 2],
  ['Oslo',       59.91,  10.75, 2],
  ['Copenhagen', 55.68,  12.57, 2],
  ['Helsinki',   60.17,  24.94, 2],
  ['Athens',     37.98,  23.73, 2],
  ['Bucharest',  44.43,  26.10, 2],
  ['Sofia',      42.70,  23.32, 3],
  ['Minsk',      53.90,  27.57, 3],
  ['Dublin',     53.33,  -6.25, 3],
  ['Edinburgh',  55.95,  -3.19, 3],
  ['Lyon',       45.75,   4.84, 3],
  ['Milan',      45.47,   9.19, 2],
  ['Naples',     40.85,  14.27, 3],
  ['Marseille',  43.30,   5.37, 3],
  ['Seville',    37.39,  -5.99, 3],
  ['Zurich',     47.38,   8.54, 3],
  ['Geneva',     46.21,   6.14, 3],
  ['Rotterdam',  51.92,   4.48, 3],
  ['Riga',       56.95,  24.11, 3],
  ['Tallinn',    59.44,  24.75, 3],
  ['Vilnius',    54.69,  25.28, 3],
  ['Krakow',     50.06,  19.94, 3],
  ['Belgrade',   44.80,  20.47, 3],
  ['Zagreb',     45.82,  15.98, 3],
  ['Sarajevo',   43.85,  18.38, 4],
  ['Tbilisi',    41.69,  44.83, 3],
  ['Yerevan',    40.18,  44.51, 3],
  ['Baku',       40.41,  49.87, 3],
  ['Reykjavik',  64.13, -21.90, 4],

  // Russia + Central Asia
  ['St. Petersburg',59.94, 30.32, 1],
  ['Novosibirsk',55.05,  82.93, 2],
  ['Yekaterinburg',56.83,60.60, 2],
  ['Vladivostok',43.12, 131.90, 3],
  ['Irkutsk',    52.29, 104.30, 3],
  ['Almaty',     43.25,  76.92, 2],
  ['Tashkent',   41.30,  69.24, 1],
  ['Astana',     51.18,  71.45, 2],

  // Africa
  ['Cairo',      30.04,  31.24, 1],
  ['Lagos',       6.45,   3.40, 1],
  ['Kinshasa',   -4.32,  15.32, 1],
  ['Johannesburg',-26.20,28.04, 1],
  ['Nairobi',    -1.29,  36.82, 1],
  ['Dar es Salaam',-6.80,39.28, 2],
  ['Addis Ababa',  9.03,  38.74, 2],
  ['Abidjan',     5.35,  -4.00, 2],
  ['Accra',       5.56,  -0.20, 2],
  ['Khartoum',   15.55,  32.53, 2],
  ['Casablanca', 33.59,  -7.62, 2],
  ['Algiers',    36.74,   3.04, 2],
  ['Tunis',      36.82,  10.17, 3],
  ['Dakar',      14.69, -17.44, 3],
  ['Kampala',     0.32,  32.58, 3],
  ['Luanda',     -8.84,  13.23, 2],
  ['Maputo',    -25.97,  32.59, 3],
  ['Lusaka',    -15.42,  28.28, 3],
  ['Harare',    -17.83,  31.05, 3],
  ['Cape Town', -33.93,  18.42, 3],
  ['Durban',    -29.87,  31.02, 3],
  ['Tripoli',    32.90,  13.18, 3],
  ['Kigali',     -1.95,  30.06, 4],

  // Middle East
  ['Riyadh',     24.69,  46.72, 1],
  ['Dubai',      25.20,  55.27, 1],
  ['Tehran',     35.69,  51.42, 1],
  ['Baghdad',    33.34,  44.40, 1],
  ['Ankara',     39.93,  32.86, 2],
  ['Izmir',      38.42,  27.14, 3],
  ['Beirut',     33.89,  35.50, 3],
  ['Damascus',   33.51,  36.29, 2],
  ['Amman',      31.95,  35.93, 3],
  ['Jerusalem',  31.77,  35.23, 3],
  ['Tel Aviv',   32.08,  34.78, 3],
  ['Kuwait City',29.37,  47.98, 3],
  ['Muscat',     23.61,  58.59, 3],
  ['Doha',       25.29,  51.53, 3],
  ['Abu Dhabi',  24.47,  54.37, 3],

  // South Asia
  ['Mumbai',     19.08,  72.88, 1],
  ['Delhi',      28.61,  77.21, 1],
  ['Kolkata',    22.57,  88.37, 1],
  ['Chennai',    13.08,  80.27, 1],
  ['Bangalore',  12.97,  77.59, 1],
  ['Hyderabad',  17.38,  78.49, 2],
  ['Karachi',    24.86,  67.01, 1],
  ['Lahore',     31.55,  74.34, 1],
  ['Dhaka',      23.72,  90.41, 1],
  ['Islamabad',  33.72,  73.04, 2],
  ['Colombo',     6.93,  79.86, 3],
  ['Kathmandu',  27.70,  85.32, 3],
  ['Kabul',      34.53,  69.17, 2],

  // SE Asia
  ['Bangkok',    13.75, 100.52, 1],
  ['Singapore',   1.35, 103.82, 1],
  ['Jakarta',    -6.21, 106.85, 1],
  ['Manila',     14.60, 120.98, 1],
  ['Kuala Lumpur', 3.14,101.69, 1],
  ['Rangoon',    16.87,  96.15, 2],
  ['Hanoi',      21.03, 105.85, 2],
  ['Ho Chi Minh',10.82, 106.63, 2],
  ['Phnom Penh', 11.55, 104.92, 3],
  ['Vientiane',  17.97, 102.60, 3],
  ['Surabaya',   -7.25, 112.75, 3],
  ['Yangon',     16.87,  96.15, 3],
  ['Bali',       -8.65, 115.22, 4],

  // East Asia
  ['Tokyo',      35.69, 139.69, 1],
  ['Beijing',    39.91, 116.39, 1],
  ['Shanghai',   31.23, 121.47, 1],
  ['Shenzhen',   22.54, 114.06, 1],
  ['Guangzhou',  23.13, 113.26, 1],
  ['Chongqing',  29.56, 106.55, 1],
  ['Chengdu',    30.66, 104.07, 1],
  ['Wuhan',      30.58, 114.27, 2],
  ['Xian',       34.27, 108.95, 2],
  ['Tianjin',    39.14, 117.18, 2],
  ['Seoul',      37.57, 126.98, 1],
  ['Busan',      35.10, 129.04, 2],
  ['Taipei',     25.05, 121.53, 1],
  ['Hong Kong',  22.28, 114.18, 1],
  ['Osaka',      34.69, 135.50, 1],
  ['Sapporo',    43.06, 141.35, 3],
  ['Ulaanbaatar',47.92, 106.92, 3],
  ['Harbin',     45.75, 126.65, 2],
  ['Urumqi',     43.80,  87.60, 3],

  // Australia + Pacific
  ['Sydney',    -33.87, 151.21, 1],
  ['Melbourne', -37.81, 144.96, 1],
  ['Brisbane',  -27.47, 153.02, 2],
  ['Perth',     -31.95, 115.86, 2],
  ['Adelaide',  -34.93, 138.60, 2],
  ['Auckland',  -36.87, 174.77, 2],
  ['Wellington',-41.29, 174.78, 3],
  ['Christchurch',-43.53,172.64,3],
  ['Suva',      -18.14, 178.44, 4],
  ['Port Moresby',-9.44,147.18, 3],
  ['Honolulu',   21.31,-157.86, 3],

  // Arctic/notable
  ['Reykjavik',  64.13, -21.90, 3],
  ['Murmansk',   68.97,  33.07, 4],
  ['Norilsk',    69.35,  88.19, 4],
];

// ═══════════════════════════════════════════════════════════════════
// REGIONS
// ═══════════════════════════════════════════════════════════════════

const REGIONS = {
  namerica: { n:60,  s:18,  w:-132, e:-60,  label:'North America' },
  europe:   { n:72,  s:34,  w:-15,  e:45,   label:'Europe' },
  asia:     { n:55,  s:-10, w:65,   e:155,  label:'Asia–Pacific' },
  world:    { n:80,  s:-60, w:-180, e:180,  label:'World' },
};

// ═══════════════════════════════════════════════════════════════════
// WIND MATH
// ═══════════════════════════════════════════════════════════════════

const DIR8 = ['↑','↗','→','↘','↓','↙','←','↖'];

function dirArrow(deg) {
  const going = (deg + 180) % 360;
  return DIR8[Math.round(going / 45) % 8];
}

function speedClass(kmh) {
  if (kmh <  5)  return 's0';
  if (kmh < 15)  return 's1';
  if (kmh < 30)  return 's2';
  if (kmh < 50)  return 's3';
  if (kmh < 75)  return 's4';
  if (kmh < 100) return 's5';
  return 's6';
}

function degToCompass(d) {
  const a = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
  return a[Math.round(d / 22.5) % 16];
}

function toKmh(v, unit) {
  if (unit === 'mph') return v * 1.60934;
  if (unit === 'ms')  return v * 3.6;
  return v;
}

function fmtSpeed(v, unit) {
  const u = unit === 'kmh' ? 'km/h' : unit === 'mph' ? 'mph' : 'm/s';
  return Math.round(v) + ' ' + u;
}

// ═══════════════════════════════════════════════════════════════════
// API + CACHE
// ═══════════════════════════════════════════════════════════════════

const CACHE = new Map();
const CACHE_TTL = 120_000;

async function fetchPoint(lat, lon, unit) {
  const key = `${lat.toFixed(2)},${lon.toFixed(2)},${unit}`;
  const c = CACHE.get(key);
  if (c && Date.now() - c.ts < CACHE_TTL) return c.data;

  const wUnit = unit === 'mph' ? 'mph' : unit === 'ms' ? 'ms' : 'kmh';
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
    `&current=wind_speed_10m,wind_direction_10m` +
    `&wind_speed_unit=${wUnit}&forecast_days=1&timezone=auto`;

  const res = await fetch(url);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const j = await res.json();
  const data = { speed: j.current.wind_speed_10m, dir: j.current.wind_direction_10m };
  CACHE.set(key, { data, ts: Date.now() });
  return data;
}

async function fetchGridPoints(bbox, unit, onProgress) {
  const latSpan = bbox.n - bbox.s;
  const lonSpan = bbox.e - bbox.w;
  const nRows = Math.max(4, Math.min(10, Math.round(latSpan / 8)));
  const nCols = Math.max(6, Math.min(16, Math.round(lonSpan / 10)));

  const tasks = [];
  for (let r = 0; r < nRows; r++) {
    for (let c = 0; c < nCols; c++) {
      const lat = bbox.n - (r + 0.5) * (latSpan / nRows);
      const lon = bbox.w + (c + 0.5) * (lonSpan / nCols);
      tasks.push({ lat: parseFloat(lat.toFixed(2)), lon: parseFloat(lon.toFixed(2)) });
    }
  }

  const points = [];
  const BATCH = 8;
  let done = 0;
  for (let i = 0; i < tasks.length; i += BATCH) {
    const batch = tasks.slice(i, i + BATCH);
    const results = await Promise.allSettled(batch.map(t => fetchPoint(t.lat, t.lon, unit)));
    results.forEach((res, j) => {
      done++;
      if (res.status === 'fulfilled') points.push({ lat: batch[j].lat, lon: batch[j].lon, ...res.value });
    });
    onProgress(done, tasks.length);
  }
  return points;
}

// ═══════════════════════════════════════════════════════════════════
// INTERPOLATION (IDW)
// ═══════════════════════════════════════════════════════════════════

function idw(points, lat, lon) {
  const EPS = 1e-9;
  let sw = 0, sspd = 0, ssin = 0, scos = 0;
  for (const p of points) {
    const d2 = (p.lat-lat)**2 + (p.lon-lon)**2 + EPS;
    const w = 1/d2;
    sw += w; sspd += w*p.speed;
    const rad = p.dir * Math.PI/180;
    ssin += w*Math.sin(rad); scos += w*Math.cos(rad);
  }
  return {
    speed: sspd/sw,
    dir: (Math.atan2(ssin/sw, scos/sw) * 180/Math.PI + 360) % 360,
  };
}

// ═══════════════════════════════════════════════════════════════════
// GRID DIMENSIONS
// ═══════════════════════════════════════════════════════════════════

function gridDims() {
  const wrap = document.getElementById('map-wrap');
  const W = wrap.clientWidth - 18;
  const H = wrap.clientHeight - 8;
  const fs = 13, lh = 13 * 1.35;
  const cw = 13 * 0.601 + 1.04;
  return {
    cols: Math.max(40, Math.floor(W / cw)),
    rows: Math.max(12, Math.floor(H / lh)),
    cw, lh,
  };
}

// ═══════════════════════════════════════════════════════════════════
// BORDER RASTERISATION (Bresenham line drawing into char grid)
// ═══════════════════════════════════════════════════════════════════

// Pick a border glyph based on the slope of the line segment
function borderGlyph(dx, dy) {
  // dx/dy in grid cells
  if (dx === 0) return '│';
  if (dy === 0) return '─';
  const slope = Math.abs(dy / dx);
  if (slope < 0.4) return '─';
  if (slope > 2.5) return '│';
  // diagonal
  return (dx * dy > 0) ? '╲' : '╱';
}

function rasteriseBorders(borderGrid, bbox, dims) {
  const { rows, cols } = dims;

  function ll2rc(lat, lon) {
    return {
      r: (bbox.n - lat)  / (bbox.n - bbox.s) * (rows - 1),
      c: (lon  - bbox.w) / (bbox.e - bbox.w) * (cols - 1),
    };
  }

  function plotLine(r0, c0, r1, c1, glyph) {
    // Bresenham
    let x0 = Math.round(c0), y0 = Math.round(r0);
    let x1 = Math.round(c1), y1 = Math.round(r1);
    const dx = Math.abs(x1-x0), dy = Math.abs(y1-y0);
    const sx = x0<x1?1:-1, sy = y0<y1?1:-1;
    let err = dx-dy;
    while (true) {
      if (x0>=0 && x0<cols && y0>=0 && y0<rows) {
        if (!borderGrid[y0][x0]) borderGrid[y0][x0] = glyph;
      }
      if (x0===x1 && y0===y1) break;
      const e2 = 2*err;
      if (e2 > -dy) { err -= dy; x0 += sx; }
      if (e2 <  dx) { err += dx; y0 += sy; }
    }
  }

  for (const polyline of BORDERS) {
    for (let i = 0; i < polyline.length - 1; i++) {
      const [lon0, lat0] = polyline[i];
      const [lon1, lat1] = polyline[i+1];

      // Skip segments entirely outside bbox (with small margin)
      const margin = 5;
      if (Math.max(lat0,lat1) < bbox.s - margin) continue;
      if (Math.min(lat0,lat1) > bbox.n + margin) continue;
      if (Math.max(lon0,lon1) < bbox.w - margin) continue;
      if (Math.min(lon0,lon1) > bbox.e + margin) continue;

      const p0 = ll2rc(lat0, lon0);
      const p1 = ll2rc(lat1, lon1);

      // Grid-space delta for glyph selection
      const dc = p1.c - p0.c, dr = p1.r - p0.r;
      const g = borderGlyph(dc, dr);
      plotLine(p0.r, p0.c, p1.r, p1.c, g);
    }
  }
}

// ═══════════════════════════════════════════════════════════════════
// CITY SELECTION — pick from DB based on bbox + density
// ═══════════════════════════════════════════════════════════════════

function selectCities(bbox, dims) {
  const { rows, cols } = dims;
  const latSpan = bbox.n - bbox.s;
  const lonSpan = bbox.e - bbox.w;

  // Cells per degree
  const rPerDeg = rows  / latSpan;
  const cPerDeg = cols / lonSpan;

  // Filter to visible cities
  const visible = CITY_DB.filter(([, lat, lon]) =>
    lat >= bbox.s && lat <= bbox.n && lon >= bbox.w && lon <= bbox.e
  );

  // Sort by rank (lower = more important)
  visible.sort((a, b) => a[3] - b[3]);

  // How many cities to show based on view area
  const area = latSpan * lonSpan;
  const maxRank = area > 20000 ? 1 : area > 5000 ? 2 : area > 1000 ? 3 : 5;

  // Spatial deduplication — keep a 'claimed' grid to avoid overlap
  const claimed = new Set();
  const chosen = [];

  for (const city of visible) {
    const [name, lat, lon, rank] = city;
    if (rank > maxRank) continue;

    // Convert to grid position
    const r = Math.round((bbox.n - lat)  / latSpan * (rows - 1));
    const c = Math.round((lon  - bbox.w) / lonSpan * (cols - 1));

    // Exclusion radius: name length + 3 chars horizontally, 1 row vertically
    const excR = 1, excC = Math.ceil(name.length / 2) + 2;
    let conflict = false;
    for (let dr = -excR; dr <= excR && !conflict; dr++) {
      for (let dc = -excC; dc <= excC && !conflict; dc++) {
        if (claimed.has((r+dr) * 1000 + (c+dc))) conflict = true;
      }
    }
    if (conflict) continue;

    // Claim cells
    for (let dr = -excR; dr <= excR; dr++)
      for (let dc = -excC; dc <= excC; dc++)
        claimed.add((r+dr) * 1000 + (c+dc));

    chosen.push({ name, lat, lon, rank, r, c });
  }

  return chosen;
}

// ═══════════════════════════════════════════════════════════════════
// BUILD DISPLAY GRID
// ═══════════════════════════════════════════════════════════════════

function buildGrid(bbox, points, dims, opts) {
  const { rows, cols } = dims;
  const { showBorders, showCities, showGrid } = opts;

  // Layer 0: null (blank)
  const grid = Array.from({ length: rows }, () =>
    Array.from({ length: cols }, () => null)
  );

  function ll2rc(lat, lon) {
    return {
      r: (bbox.n - lat)  / (bbox.n - bbox.s) * (rows - 1),
      c: (lon  - bbox.w) / (bbox.e - bbox.w) * (cols - 1),
    };
  }

  // ── Layer 1: Graticule ──
  if (showGrid) {
    const latSpan = bbox.n - bbox.s, lonSpan = bbox.e - bbox.w;
    const latStep = latSpan > 60 ? 20 : latSpan > 30 ? 10 : 5;
    const lonStep = lonSpan > 120 ? 40 : lonSpan > 60 ? 20 : 10;

    for (let lat = Math.ceil(bbox.s/latStep)*latStep; lat <= bbox.n; lat += latStep) {
      const ri = Math.round(ll2rc(lat, bbox.w).r);
      if (ri >= 0 && ri < rows) {
        for (let c = 0; c < cols; c++) grid[ri][c] = { char:'·', cls:'gr', lat, lon:bbox.w+c/cols*lonSpan, type:'gr' };
      }
    }
    for (let lon = Math.ceil(bbox.w/lonStep)*lonStep; lon <= bbox.e; lon += lonStep) {
      const ci = Math.round(ll2rc(bbox.n, lon).c);
      if (ci >= 0 && ci < cols) {
        for (let r = 0; r < rows; r++) {
          const lat = bbox.n - r/(rows-1)*(bbox.n-bbox.s);
          if (!grid[r][ci] || grid[r][ci].cls === 'gr')
            grid[r][ci] = { char:'·', cls:'gr', lat, lon, type:'gr' };
        }
      }
    }
  }

  // ── Layer 2: Graticule labels ──
  if (showGrid) {
    const latSpan = bbox.n - bbox.s, lonSpan = bbox.e - bbox.w;
    const latStep = latSpan > 60 ? 20 : latSpan > 30 ? 10 : 5;
    const lonStep = lonSpan > 120 ? 40 : lonSpan > 60 ? 20 : 10;

    for (let lat = Math.ceil(bbox.s/latStep)*latStep; lat <= bbox.n; lat += latStep) {
      const ri = Math.round(ll2rc(lat, bbox.w).r);
      const lbl = (lat >= 0 ? '+' : '') + lat + '°';
      for (let k = 0; k < lbl.length && k < cols; k++)
        grid[ri < rows ? ri : rows-1][k] = { char:lbl[k], cls:'lb', lat, lon:bbox.w, type:'label' };
    }
  }

  // ── Layer 3: Wind arrows (fill every cell) ──
  for (let r = 0; r < rows; r++) {
    for (let c = 0; c < cols; c++) {
      const lat = bbox.n - r/(rows-1)*(bbox.n-bbox.s);
      const lon = bbox.w + c/(cols-1)*(bbox.e-bbox.w);
      const { speed, dir } = idw(points, lat, lon);
      const kmh = toKmh(speed, 'kmh'); // always kmh for class
      grid[r][c] = { char: dirArrow(dir), cls: speedClass(kmh), lat, lon, speed, dir, type:'arrow' };
    }
  }

  // ── Layer 4: Country borders ──
  if (showBorders) {
    // Build a separate border grid, then merge (borders don't carry wind data)
    const bGrid = Array.from({ length: rows }, () => Array(cols).fill(null));
    rasteriseBorders(bGrid, bbox, dims);
    for (let r = 0; r < rows; r++) {
      for (let c = 0; c < cols; c++) {
        if (bGrid[r][c]) {
          const cell = grid[r][c];
          // Keep wind metadata but change char + class
          grid[r][c] = { ...cell, char: bGrid[r][c], cls: 'bo', type: 'border' };
        }
      }
    }
  }

  // ── Layer 5: Cities ──
  if (showCities) {
    const cities = selectCities(bbox, dims);

    for (const city of cities) {
      const { name, lat, lon, r: ri, c: ci } = city;
      if (ri < 0 || ri >= rows || ci < 0 || ci >= cols) continue;

      const { speed, dir } = idw(points, lat, lon);

      // City arrow character
      grid[ri][ci] = {
        char: dirArrow(dir), cls: 'ca',
        lat, lon, speed, dir, type: 'city', cityName: name,
      };

      // Label placement: try right, then left
      const lbl = name;
      let labelStart = ci + 1;
      if (labelStart + lbl.length >= cols) labelStart = ci - lbl.length - 1;
      labelStart = Math.max(0, labelStart);

      for (let k = 0; k < lbl.length; k++) {
        const lc = labelStart + k;
        if (lc < 0 || lc >= cols) continue;
        const existing = grid[ri][lc];
        if (existing && (existing.type === 'city' || existing.type === 'city-label')) continue;
        grid[ri][lc] = {
          char: lbl[k], cls: 'cn',
          lat, lon, speed, dir, type: 'city-label', cityName: name,
        };
      }
    }
  }

  return grid;
}

// ═══════════════════════════════════════════════════════════════════
// RENDER GRID → HTML + PLAIN TEXT
// ═══════════════════════════════════════════════════════════════════

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function renderGrid(grid) {
  const rows = grid.length, cols = grid[0].length;
  let html = '', plain = '';

  for (let r = 0; r < rows; r++) {
    let rh = '', rp = '';
    for (let c = 0; c < cols; c++) {
      const cell = grid[r][c];
      const ch = cell ? cell.char : ' ';
      rp += ch;
      if (!cell) { rh += ' '; continue; }
      const attrs = cell.speed !== undefined
        ? ` data-r="${r}" data-c="${c}"`
        : '';
      rh += `<span class="${cell.cls}"${attrs}>${escHtml(ch)}</span>`;
    }
    html  += rh + '\n';
    plain += rp + '\n';
  }
  return { html, plain };
}

// ═══════════════════════════════════════════════════════════════════
// APP STATE
// ═══════════════════════════════════════════════════════════════════

let currentBbox   = REGIONS.namerica;
let currentUnit   = 'kmh';
let currentPoints = [];
let currentGrid   = null;
let plainText     = '';
let showBorders   = true;
let showCities    = true;
let showGrid      = false;

const mapEl     = document.getElementById('map');
const dotEl     = document.getElementById('tb-dot');
const statusEl  = document.getElementById('topbar-status');
const coordsEl  = document.getElementById('tb-coords');
const tooltipEl = document.getElementById('tooltip');

function setStatus(state, msg) {
  dotEl.className = 'tb-dot' + (state ? ' ' + state : '');
  statusEl.textContent = msg;
}

// ═══════════════════════════════════════════════════════════════════
// LOAD + RENDER PIPELINE
// ═══════════════════════════════════════════════════════════════════

async function loadAndRender() {
  const bbox = currentBbox;
  const unit = currentUnit;

  setStatus('loading', 'Fetching wind data…');
  mapEl.textContent = 'Fetching ' + (bbox.label||'region') + '…\n\nbatching API calls, please wait…';

  try {
    const pts = await fetchGridPoints(bbox, unit, (done, total) => {
      setStatus('loading', `Fetching… ${done}/${total} grid points`);
    });
    if (!pts.length) throw new Error('No data returned');
    currentPoints = pts;
    renderMap();
    const ts = new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    setStatus('ok', `${bbox.label||'Custom'} · ${pts.length} samples · ${ts}`);
  } catch (err) {
    setStatus('error', 'Error: ' + err.message);
    mapEl.textContent = '[fetch error: ' + err.message + ']';
  }
}

function renderMap() {
  if (!currentPoints.length) return;
  const dims = gridDims();
  const grid = buildGrid(currentBbox, currentPoints, dims, { showBorders, showCities, showGrid });
  currentGrid = grid;
  const { html, plain } = renderGrid(grid);
  plainText = plain;
  mapEl.innerHTML = html;
}

// ═══════════════════════════════════════════════════════════════════
// TOOLTIP
// ═══════════════════════════════════════════════════════════════════

mapEl.addEventListener('mousemove', e => {
  const span = e.target.closest('span[data-r]');
  if (!span || !currentGrid) {
    tooltipEl.classList.remove('show');
    coordsEl.textContent = '—';
    return;
  }
  const r = +span.dataset.r, c = +span.dataset.c;
  const cell = currentGrid[r]?.[c];
  if (!cell || cell.speed === undefined) { tooltipEl.classList.remove('show'); return; }

  const latStr = Math.abs(cell.lat).toFixed(2) + '°' + (cell.lat>=0?'N':'S');
  const lonStr = Math.abs(cell.lon).toFixed(2) + '°' + (cell.lon>=0?'E':'W');
  coordsEl.textContent = latStr + ' ' + lonStr;

  let inner = `<span class="tt-v">${latStr} ${lonStr}</span>\n`;
  if (cell.cityName) inner += `<span class="tt-v">${cell.cityName}</span>\n`;
  inner += `Wind  <span class="tt-v">${fmtSpeed(cell.speed, currentUnit)}</span>\n`;
  inner += `From  <span class="tt-v">${Math.round(cell.dir)}° ${degToCompass(cell.dir)}</span>`;

  tooltipEl.innerHTML = inner;
  tooltipEl.classList.add('show');
  tooltipEl.style.left = Math.min(e.clientX+14, window.innerWidth-160) + 'px';
  tooltipEl.style.top  = Math.min(e.clientY+14, window.innerHeight-110) + 'px';
});

mapEl.addEventListener('mouseleave', () => {
  tooltipEl.classList.remove('show');
  coordsEl.textContent = '—';
});

// ═══════════════════════════════════════════════════════════════════
// CONTROLS
// ═══════════════════════════════════════════════════════════════════

document.querySelectorAll('.region-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.region-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentBbox = { ...REGIONS[btn.dataset.region] };
    ['in-n','in-s','in-w','in-e'].forEach(id => document.getElementById(id).value = '');
    loadAndRender();
  });
});

document.querySelectorAll('.unit-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.unit-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentUnit = btn.dataset.unit;
    CACHE.clear();
    loadAndRender();
  });
});

document.getElementById('btn-go').addEventListener('click', () => {
  const n = parseFloat(document.getElementById('in-n').value);
  const s = parseFloat(document.getElementById('in-s').value);
  const w = parseFloat(document.getElementById('in-w').value);
  const e = parseFloat(document.getElementById('in-e').value);
  if ([n,s,w,e].some(isNaN))  { setStatus('error','Invalid bbox'); return; }
  if (n <= s || e <= w)       { setStatus('error','Need N>S, E>W'); return; }
  currentBbox = { n, s, w, e, label:`Custom` };
  document.querySelectorAll('.region-btn').forEach(b => b.classList.remove('active'));
  loadAndRender();
});

['in-n','in-s','in-w','in-e'].forEach(id =>
  document.getElementById(id).addEventListener('keydown', e => {
    if (e.key === 'Enter') document.getElementById('btn-go').click();
  })
);

// Toggle buttons
function bindToggle(id, getter, setter) {
  const btn = document.getElementById(id);
  btn.addEventListener('click', () => {
    setter(!getter());
    btn.classList.toggle('active', getter());
    renderMap();
  });
}

bindToggle('btn-borders', () => showBorders, v => { showBorders = v; });
bindToggle('btn-cities',  () => showCities,  v => { showCities  = v; });
bindToggle('btn-grid',    () => showGrid,    v => { showGrid    = v; });

document.getElementById('btn-refresh').addEventListener('click', () => {
  CACHE.clear();
  loadAndRender();
});

document.getElementById('btn-copy').addEventListener('click', () => {
  if (!plainText) return;
  navigator.clipboard.writeText(plainText).then(() => {
    const btn = document.getElementById('btn-copy');
    const orig = btn.textContent;
    btn.textContent = '✓ Copied!';
    setTimeout(() => btn.textContent = orig, 1800);
  });
});

// ═══════════════════════════════════════════════════════════════════
// RESIZE
// ═══════════════════════════════════════════════════════════════════

let resizeTimer;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(() => { if (currentPoints.length) renderMap(); }, 200);
});

// ── Init ────────────────────────────────────────────────────────
loadAndRender();
</script>
</body>
</html>
